<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<title>Chat</title>

<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: "Inter", sans-serif;
}

body {
    background: url("./images/background.png") center/contain fixed;
    color: #f2f2f2;
    min-height: 100dvh;
}

/* ===== CONTAINER ===== */
.container {
    min-height: 100dvh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 16px;
}

/* ===== LOGIN ===== */
.login {
    width: 100%;
    max-width: 360px;
    background: #1b1b1b;
    padding: 24px;
    border-radius: 12px;
}

.login h2 {
    text-align: center;
    margin-bottom: 20px;
}

.login__form {
    display: flex;
    flex-direction: column;
    gap: 14px;
}

.login__input {
    padding: 14px;
    border-radius: 8px;
    border: none;
    background: #121212;
    color: #fff;
}

.login__button {
    padding: 14px;
    border-radius: 8px;
    border: none;
    background: #e5e5e5;
    color: #000;
    font-weight: 700;
}

/* ===== CHAT ===== */
.chat {
    display: none;
    flex-direction: column;
    width: 100%;
    height: 100dvh;
}

/* ===== MESSAGES ===== */
.chat__messages {
    flex: 1;
    padding: 16px;
    padding-bottom: 90px;

    overflow-y: auto;

    display: flex;
    flex-direction: column-reverse; /* üî• chave do problema */
}

.chat__messages > div {
    min-width: 120px;          /* üî• tamanho m√≠nimo */
    min-height: 44px;          /* üî• altura m√≠nima (visual melhor) */

    padding: 12px 14px;
    border-radius: 14px;

    display: flex;
    flex-direction: column;
    justify-content: center;
    margin-top: 12px;
}

.message--self {
    background: #f2f2f2;
    color: #000;
    align-self: flex-end;
    border-bottom-right-radius: 4px;
}

.message--other {
    background: #2a2a2a;
    align-self: flex-start;
    border-bottom-left-radius: 4px;
}

.message--sender {
    font-size: 0.7rem;
    font-weight: 600;
    color: cadetblue;
    margin-bottom: 6px;
}

/* ===== FORM FIXO ===== */
.chat__form {
    position: fixed;
    bottom: env(safe-area-inset-bottom);
    left: 0;
    width: 100%;
    padding: 15px;
    background: #141414;
    display: flex;
    align-items: center;
    gap: 16px;
}

.chat__input {
    flex: 1;
    padding: 12px;
    border-radius: 20px;
    border: none;
    background: #222;
    color: #fff;
}

.chat__button {
    background: none;
    border: none;
    color: #fff;
}

/* ===== FILE ===== */
#btn_anx svg {
    width: 24px;
    height: 24px;
}

/* ===== COLOR INPUT ===== */
#corInput {
    width: 110px;
    padding: 8px;
    border-radius: 6px;
    border: none;
}

/* ===== LOADING ===== */
.loading {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
}

/* ===== GIF / IMAGE ===== */
.blkk-img {
    max-width: 90vw;
    max-height: 60vh;
    border-radius: 12px;
}

/* ===== YOUTUBE PLAYER ===== */
.youtube-player {
    position: fixed;
    top: 12px;
    left: 50%;
    transform: translateX(-50%);
    width: 92%;
    max-width: 380px;
    aspect-ratio: 16 / 9;
    background: #000;
    border-radius: 14px;
    overflow: hidden;
    z-index: 9999;
}

.youtube-player iframe {
    width: 100%;
    height: 100%;
}

/* ===== DESKTOP ===== */
@media (min-width: 768px) {
    .chat__messages {
        padding: 30px;
        padding-bottom: 110px;
    }

    .chat__messages div {
        max-width: 420px;
    }

    .youtube-player {
        left: auto;
        right: 20px;
        transform: none;
    }
}
</style>
</head>

<body>

<section class="container">

<section class="login">
    <h2>Login</h2>
    <form class="login__form">
        <input type="text" class="login__input" placeholder="Seu nome" required>
        <button class="login__button">Entrar</button>
    </form>
</section>

<section class="chat">
    <div class="loading" style="display:none">
        <p>Aguarde...</p>
    </div>

    <section class="chat__messages"></section>

    <form class="chat__form">
<label action="/upload" for="file" id="btn_anx" class="" data-icon="attach-menu-plus">
                <svg viewBox="0 0 24 24" height="24" width="24" preserveAspectRatio="xMidYMid meet" fill="none" class="">
                    <title>attach-menu-plus</title>
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M20.5 13.2501L20.5 10.7501L13.25 10.7501L13.25 3.5L10.75 3.5L10.75 10.7501L3.5 10.7501L3.5 13.2501L10.75 13.2501L10.75 20.5L13.25 20.5L13.25 13.2501L20.5 13.2501Z" fill="currentColor"></path>
                </svg>
                <input type="file" name="file" id="file" accept="image/*, video/*, .txt" style="display:none;">
            </label>

        <input class="chat__input" placeholder="Digite uma mensagem">

        <button class="chat__button">
            <span class="material-symbols-outlined">send</span>
        </button>
    </form>
</section>

</section>

<script>
    /*************************
 * VARI√ÅVEIS GLOBAIS
 *************************/
let websocket;
let ytPlayerDiv = null;
let iframeAvancado = false;


const colors = [
    "cadetblue",
    "darkgoldenrod",
    "cornflowerblue",
    "darkkhaki",
    "hotpink",
    "gold"
];

const user = { id: "", name: "", color: "" };

/*************************
 * DOM ELEMENTS
 *************************/
const login = document.querySelector(".login");
const loginForm = login.querySelector(".login__form");
const loginInput = login.querySelector(".login__input");

const chat = document.querySelector(".chat");
const chatForm = chat.querySelector(".chat__form");
const chatInput = chat.querySelector(".chat__input");
const chatMessages = chat.querySelector(".chat__messages");

/*************************
 * HELPERS
 *************************/
const getRandomColor = () => colors[Math.floor(Math.random() * colors.length)];

const scrollScreen = () => {
    if (window.innerWidth <= 768) {
        chatMessages.scrollTop = 0;
        return;
    }

    // PC continua igual
    window.scrollTo({
        top: document.body.scrollHeight,
        behavior: "smooth"
    });
};


const isSanitizationEnabled = () =>
    new URLSearchParams(window.location.search).get("sanitization") !== "false";

function sanitizeInput(input) {
    if (!isSanitizationEnabled()) return input;

    const forbidden = /<(script|iframe|object|embed|style|link|a|img|h1|h2|h3|h4|h5|h6|div).*?>/gi;
    if (forbidden.test(input)) {
        alert("Aten√ß√£o: Scripts n√£o s√£o permitidos!");
        return null;
    }
    return input.replace(forbidden, "");
}

const playNotificationSound = () => {
    new Audio("./sounds/aviso.mp3").play().catch(() => {});

    if (Notification.permission === "granted") {
        new Notification("CHAT GHOSTHSZZ_", { body: "Voc√™ tem novas mensagens no chat!" });
    } else if (Notification.permission !== "denied") {
        Notification.requestPermission().then(p => {
            if (p === "granted") new Notification("CHAT GHOSTHSZZ_", { body: "Voc√™ tem novas mensagens no chat!" });
        });
    }
};
function scrollChatToBottomMobile() {
    if (window.innerWidth > 768) return; // PC n√£o mexe

    chatMessages.scrollTop = chatMessages.scrollHeight;
}

/*************************
 * MENSAGENS
 *************************/
const createMessageSelfElement = content => {
    const div = document.createElement("div");
    div.className = "message--self";
    div.innerHTML = content;
    return div;
};

const createMessageOtherElement = (content, sender, color) => {
    const div = document.createElement("div");
    div.className = "message--other";

    const span = document.createElement("span");
    span.className = "message--sender";
    span.style.color = "color";
    span.style.fontSize = '15px'
    span.innerHTML = sender;

    div.appendChild(span);
    div.innerHTML += content;
    return div;
};

/*************************
 * YOUTUBE PLAYER
 *************************/
function criarOuAtualizarPlayer(videoId) {
    if (!ytPlayerDiv) {
        ytPlayerDiv = document.createElement("div");
        ytPlayerDiv.className = "youtube-player";
        document.body.appendChild(ytPlayerDiv);
    }

    const origin = window.location.origin;

ytPlayerDiv.innerHTML = `
    <div class="yt-header">
        <span>üéß Tocando agora</span>

        <div class="yt-actions">
            <button onclick="controlarPlayer('change')">‚è≠</button>
            <button onclick="controlarPlayer('close')">‚úñ</button>
        </div>
    </div>

    <iframe
        src="https://www.youtube-nocookie.com/embed/${videoId}?enablejsapi=1&origin=${origin}&autoplay=1"
        allow="autoplay; encrypted-media"
        allowfullscreen>
    </iframe>

    <button class="yt-sound-btn pulse"
        onclick="desmutarPlayer(); this.remove();">
        <span>üîä</span>
        Ativar som
    </button>
`;

}
function desmutarPlayer() {
    const iframe = ytPlayerDiv?.querySelector("iframe");
    if (!iframe) return;

    iframe.contentWindow.postMessage(JSON.stringify({
        event: "command",
        func: "unMute",
        args: []
    }), "*");
}

function controlarPlayer(action) {
    if (!ytPlayerDiv) return;

    if (action === "close") {
        ytPlayerDiv.remove();
        ytPlayerDiv = null;
        iframeAvancado = false;
    }

    if (action === "change") {
        iframeAvancado = false;
        abrirModalIframe();
    }
}

function extrairVideoId(url) {
    try {
        const u = new URL(url);
        if (u.hostname.includes("youtu.be")) return u.pathname.slice(1);
        if (u.searchParams.get("v")) return u.searchParams.get("v");
    } catch {}
    return null;
}


/*************************
 * MODAL IFRAME
 *************************/
function controlesAvancadosHTML() {
    return `
        <button data-action="pause">‚è∏ Pausar</button>
        <button data-action="play">‚ñ∂Ô∏è Play</button>
        <button data-action="change">‚è≠ Trocar</button>
        <button data-action="close">‚ùå Fechar</button>
    `;
}

function bindControlesAvancados(modal) {
    modal.querySelectorAll("button").forEach(btn => {
        btn.onclick = () => {
            websocket.send(JSON.stringify({
                type: "IFRAME_CONTROL",
                action: btn.dataset.action
            }));
            modal.remove();
        };
    });
}

function abrirModalIframe() {
    const modal = document.createElement("div");
    modal.style = `
        position: fixed; inset:0;
        background: rgba(0,0,0,.7);
        display: flex; align-items: center; justify-content: center;
        z-index: 10000;
    `;

modal.innerHTML = `
    <div class="yt-modal">
        <h3>üéµ YouTube Player</h3>
        ${iframeAvancado ? controlesAvancadosHTML() : `
            <input id="ytLink" placeholder="Cole o link do YouTube">
            <button id="playYT">Reproduzir</button>
        `}
    </div>
`;

    document.body.appendChild(modal);
    modal.onclick = e => e.target === modal && modal.remove();

    if (!iframeAvancado) {
        document.getElementById("playYT").onclick = () => {
            const videoId = extrairVideoId(document.getElementById("ytLink").value);
            if (!videoId) return alert("Link inv√°lido");

            websocket.send(JSON.stringify({ type: "IFRAME_PLAY", videoId }));
            iframeAvancado = true;
            modal.remove();
        };
    } else {
        bindControlesAvancados(modal);
    }
}

/*************************
 * PROCESSAMENTO DE MENSAGENS
 *************************/
const processMessage = ({ data }) => {
    const payload = JSON.parse(data);

    // Player YouTube
    if (payload.type === "IFRAME_PLAY") {
        criarOuAtualizarPlayer(payload.videoId);
        return;
    }

    if (payload.type === "IFRAME_CONTROL") {
        controlarPlayer(payload.action);
        return;
    }

    const { userId, userName, userColor, content } = payload;
    const isCurrentUser = userId === user.id;
    const textContent = content.replace(/<\/?[^>]+(>|$)/g, "").trim();

    // Comandos especiais
    if (textContent.toLowerCase() === "!cp") {
        const overlay = document.createElement("div");
        overlay.style = `position: fixed; inset:0; background: rgba(0,0,0,.8); display:flex;align-items:center;justify-content:center; z-index:9999;`;
        overlay.innerHTML = `<img src="images/jump.gif" style="max-width:90vw; max-height:90vh;"><audio id="jumpAudio" autoplay><source src="sounds/jump.mp3"></audio>`;
        overlay.onclick = () => { overlay.remove(); document.getElementById('jumpAudio')?.pause(); };
        document.body.appendChild(overlay);
        setTimeout(() => { overlay.remove(); document.getElementById('jumpAudio')?.pause(); }, 1500);
        return;
    }

    if (textContent.toLowerCase() === "!mr") {
        const overlay = document.createElement("div");
        overlay.style = `position: fixed; inset:0; background: rgba(0,0,0,.8); display:flex;align-items:center;justify-content:center; z-index:9999;`;
        overlay.innerHTML = `<img src="images/gm.png" style="max-width:90vw; max-height:90vh;"><audio id="jumpAudio" autoplay><source src="sounds/gm.mp3"></audio>`;
        overlay.onclick = () => { overlay.remove(); document.getElementById('jumpAudio')?.pause(); };
        document.body.appendChild(overlay);
        setTimeout(() => { overlay.remove(); }, 5000);
        return;
    }

    // Mensagem normal
    const message = isCurrentUser
        ? createMessageSelfElement(content)
        : createMessageOtherElement(content, userName, userColor);

chatMessages.prepend(message);
scrollScreen();



    if (!isCurrentUser) playNotificationSound();
};

/*************************
 * LOGIN
 *************************/
const handleLogin = event => {
    event.preventDefault();

    user.id = crypto.randomUUID();
    user.name = loginInput.value;
    user.color = getRandomColor();

    login.style.display = "none";
    chat.style.display = "flex";

    websocket = new WebSocket("wss://chat-niha.onrender.com");
    websocket.onmessage = processMessage;

    websocket.onopen = () => {
websocket.send(JSON.stringify({
    userId: "system",
    userName: `
        <div style="display:flex;align-items:center;gap:8px;">
            <img src="images/sistema.png"
                 style="width:28px;height:28px;border-radius:50%;">
            <span style="font-weight:700;color:#7D5AC1;">Sistema</span>
        </div>
    `,
    userColor: "#7D5AC1",
    content: `
        <div class="system-message-content" style="margin-top:6px;">
            <strong>${user.name}</strong> entrou no chat
        </div>
    `
}));

    };
};

/*************************
 * ENVIO DE MENSAGENS
 *************************/
const sendMessage = event => {
    event.preventDefault();

    // Comando especial para abrir modal do YouTube
    if (chatInput.value.trim().toLowerCase() === "!iframe") {
        abrirModalIframe();
        chatInput.value = "";
        return;
    }

    // Sanitiza√ß√£o do input
    const sanitized = sanitizeInput(chatInput.value);
    if (sanitized === null) return;

    // Pegar a cor escolhida pelo usu√°rio
const corInput = document.getElementById("corInput");
const userColor = corInput?.value || "#6e40c9";


    // Enviar mensagem pelo WebSocket com a cor selecionada
    websocket.send(JSON.stringify({
        userId: user.id,
        userName: user.name,
        userColor, // cor escolhida pelo usu√°rio
        content: `<h1 style="font-size: 20px; color: ${userColor};">${sanitized}</h1>`
    }));

    // Limpar input
    chatInput.value = "";
};


/*************************
 * ENVIO DE ARQUIVOS
 *************************/
document.getElementById('file')?.addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => {
        let content = "";
        if (file.type.startsWith("image/")) content = `<img src="${reader.result}" style="max-width:50px; max-height: 50px:">`;
        if (file.type.startsWith("video/")) content = `<video controls style="max-width:200px;"><source src="${reader.result}" type="${file.type}"></video>`;
        websocket.send(JSON.stringify({
            userId: user.id,
            userName: user.name,
            userColor: user.color,
            content
        }));
    };
    reader.readAsDataURL(file);
});

/*************************
 * EVENTOS
 *************************/
loginForm.addEventListener("submit", handleLogin);
chatForm.addEventListener("submit", sendMessage);

document.addEventListener("DOMContentLoaded", () => {
    document.addEventListener("mousedown", e => {
        if (e.target.id === "img_user") {
            const overlay = document.createElement("div");
            overlay.style = `position:fixed;inset:0;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;z-index:9999;`;
            overlay.innerHTML = `<img src="${e.target.src}" style="max-width:90vw; max-height:90vh;">`;
            overlay.onclick = () => overlay.remove();
            document.body.appendChild(overlay);
        }
document.addEventListener("click", () => {
    desmutarPlayer();
}, { once: true });

        if (Notification.permission !== "granted") Notification.requestPermission();
    });
});

</script>
</body>
</html>
